# M-REM Results

Here we present the results of preliminary experiments performed using M-REM on TIER-IV's internal dataset using [multimodel_t4_dataset_selector.py](../multimodal_t4_dataset_selector.py) script.


## Results Summary
|                                   | mAP  | car  | truck | bus  | bicycle | pedestrian |
| --------------------------------- | ---- | ---- | ----- | ---- | ------- | ---------- |
| Baseline                          | 64.9 | 81.1 | 52.6  | 68.9 | 59.2    | 62.6       |
| Random data                       | 56.3 | 70.3 | 47.4  | 73.5 | 38.3    | 52.0       |
| M-REM data mining (min_score=0.1) | 56.4 | 69.5 | 45.0  | 64.4 | 51.5    | 51.5       |
| M-REM data mining (min_score=0.3) | 56.6 | 71.0 | 44.9  | 64.7 | 50.8    | 51.7       |

**The baseline model performs better than fine-tuning, so there is clearly a problem with the fine-tuning process. The learning rate might to be too high. But, this document can be used as a reference for the methodology to evaluate the performance of the scene selector.**

## Sampling Details

We sample 100 datasets (M-REM sampling) from [db_jpntaxi_v4](../../../autoware_ml/configs/t4dataset/db_jpntaxi_v4.yaml) using the following parameters:

```python
# models used for mrem
models = {
  "BEVFusion_CL_120m": bevfusion_CL_t4xx1_fusion_120m_v1,
  "Transfusion_XX1_90m_v2": transfusion_lidar_20e_t4xx1_90m_768grid
}
# iou threshold to match objects among predictions of different models
iou_threshold=0.5,   
# minimum threshold to consider a bounding box an object for each model
min_score = 0.1 or 0.3,
# number of points to consider a bounding box an object
p_thresh=10,
# only objects withing this distance are considered
d_thresh=50,
# the scene must have at least this many objects to be selected
min_rare_objects=3,
# the threshold of an object must be at least this much to be considered a rare object, set to the 90th percentile over all sequences. The percentile can be easily calculated by using the metadata file generated by multimodel_t4_dataset_selector.py
rareness_threshold=0.08574427186269773 for min_score 0.1 | 0.11431113724310737 for min_score 0.3,   

```
We use the 100 scenes with the highest `target_scene_ratio` which is the ratio of rare frames in a scene. This field can be found in the metadata file generated by [multimodel_t4_dataset_selector.py](../multimodal_t4_dataset_selector.py).

We then perform random sampling from [db_jpntaxi_v4](../../../autoware_ml/configs/t4dataset/db_jpntaxi_v4.yaml) to match the same number of objects as M-REM sampling (because the annotation cost is charged by object count). We fine-tune `TransFusion-L base/0.3` model checkpoint for **10 epochs** using the two datasets and compare the results.

---

### Training Set Distribution
#### MREM Sampling (min_score=0.1)
```
Dataset Length: 2170
Category-wise Instances:
| Category   | Count  |
|------------|--------|
| Car        | 33001  |
| Truck      | 10836  |
| Bus        | 3381   |
| Bicycle    | 889    |
| Pedestrian | 36874  |
```

#### MREM Sampling (min_score=0.3)
```
Dataset Length: 2141
Category-wise Instances:
| Category   | Count  |
|------------|--------|
| Car        | 30864  |
| Truck      | 11325  |
| Bus        | 3417   |
| Bicycle    | 863    |
| Pedestrian | 36497  |
```

#### Random Sampling (with same number of objects as M-REM)
```
Dataset Length: 3522
Category-wise Instances:
| Category   | Count  |
|------------|--------|
| Car        | 32918  |
| Truck      | 21703  |
| Bus        | 4990   |
| Bicycle    | 912    |
| Pedestrian | 22636  |
```

---

## Results on Test Dataset

### MREM Sampling (min_score=0.1)
```
Total mAP: 0.566
| Class      | mAP  | AP@0.5m | AP@1.0m | AP@2.0m | AP@4.0m |
|------------|------|--------|--------|--------|--------|
| Car        | 71.0 | 55.2   | 72.4   | 77.7   | 78.9   |
| Truck      | 44.9 | 21.5   | 40.5   | 53.6   | 63.9   |
| Bus        | 64.7 | 40.8   | 64.8   | 75.4   | 77.7   |
| Bicycle    | 50.8 | 45.8   | 52.1   | 52.5   | 52.8   |
| Pedestrian | 51.7 | 45.8   | 49.2   | 54.0   | 57.9   |
```

### MREM Sampling (min_score=0.3)
```
Total mAP: 0.564
| Class      | mAP  | AP@0.5m | AP@1.0m | AP@2.0m | AP@4.0m |
|------------|------|--------|--------|--------|--------|
| Car        | 69.5 | 52.1   | 71.6   | 76.5   | 77.7   |
| Truck      | 45.0 | 21.4   | 41.0   | 53.7   | 63.8   |
| Bus        | 64.4 | 44.1   | 63.4   | 73.7   | 76.3   |
| Bicycle    | 51.5 | 46.0   | 53.0   | 53.2   | 53.6   |
| Pedestrian | 51.5 | 45.0   | 49.1   | 54.1   | 57.8   |
```

### Random Sampling (with same number of objects as M-REM)
```
Total mAP: 0.563
| Class      | mAP  | AP@0.5m | AP@1.0m | AP@2.0m | AP@4.0m |
|------------|------|--------|--------|--------|--------|
| Car        | 70.3 | 53.7   | 72.0   | 77.1   | 78.5   |
| Truck      | 47.4 | 24.8   | 44.1   | 55.8   | 65.0   |
| Bus        | 73.5 | 53.0   | 73.9   | 81.5   | 85.6   |
| Bicycle    | 38.3 | 34.5   | 39.4   | 39.6   | 39.9   |
| Pedestrian | 52.0 | 44.5   | 49.2   | 54.8   | 59.5   |

```

### Baseline model (without training with db_jpntaxi_v4 )
```
Total mAP: 0.649
------------- T4Metric results -------------
| class_name | mAP  | AP@0.5m | AP@1.0m | AP@2.0m | AP@4.0m |
| ---- | ---- | ---- | ---- | ---- | ---- |
| car        | 81.1 | 62.3    | 82.5    | 88.8    | 90.8    |
| truck      | 52.6 | 28.4    | 50.3    | 62.2    | 69.7    |
| bus        | 68.9 | 48.6    | 69.4    | 76.3    | 81.5    |
| bicycle    | 59.2 | 53.9    | 59.8    | 61.3    | 61.8    |
| pedestrian | 62.6 | 56.1    | 60.8    | 65.1    | 68.3    |


```
---

### Impressions

At first glance, **M-REM does not significantly improve performance on average**. A deeper look reveals:
- M-REM favors datasets with a **larger number of objects**, potentially leading to bias.
- The **random sampled dataset has more diverse examples**, which may skew comparisons.
- **Pedestrian class performance did not improve**, despite M-REM selecting more pedestrian-heavy datasets.
- M-REM **performed better on bicycles**, despite fewer bicycle instances.
- The **current sampling strategy may need improvement**, or the models used for sampling may have inherent limitations.

More experiments will be conduced in future to clarify these observations.

---

